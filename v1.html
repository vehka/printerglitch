<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Analog Glitch Art Generator</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                margin: 0;
                padding: 20px;
                font-family: "Special Elite", "Courier New", monospace;
                background: #1a1a1a;
                color: #ffffff;
                display: flex;
                gap: 20px;
            }

            #canvas-container {
                flex: 1;
                background: white;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                display: flex;
                justify-content: center;
                align-items: flex-start;
                overflow: auto;
            }

            #controls {
                width: 320px;
                background: #2a2a2a;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                height: fit-content;
                max-height: 90vh;
                overflow-y: auto;
            }

            .control-group {
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #444;
            }

            .control-group:last-child {
                border-bottom: none;
            }

            h2 {
                margin: 0 0 15px 0;
                font-size: 14px;
                text-transform: uppercase;
                color: #888;
                letter-spacing: 1px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-size: 12px;
                color: #aaa;
            }

            input[type="range"] {
                width: 100%;
                margin-bottom: 5px;
            }

            input[type="checkbox"] {
                margin-right: 8px;
            }

            button {
                width: 100%;
                padding: 12px;
                margin: 5px 0;
                background: #4a9eff;
                border: none;
                color: white;
                font-family: "Special Elite", "Courier New", monospace;
                font-size: 13px;
                cursor: pointer;
                border-radius: 4px;
                transition: background 0.2s;
            }

            button:hover {
                background: #357abd;
            }

            button.secondary {
                background: #555;
            }

            button.secondary:hover {
                background: #666;
            }

            .value-display {
                float: right;
                color: #4a9eff;
                font-weight: bold;
            }

            textarea {
                width: 100%;
                height: 100px;
                background: #1a1a1a;
                border: 1px solid #444;
                color: #fff;
                font-family: "Special Elite", "Courier New", monospace;
                font-size: 11px;
                padding: 8px;
                box-sizing: border-box;
                resize: vertical;
            }

            .checkbox-group {
                margin: 8px 0;
            }

            select {
                width: 100%;
                padding: 8px;
                background: #1a1a1a;
                border: 1px solid #444;
                color: #fff;
                font-family: "Special Elite", "Courier New", monospace;
                font-size: 12px;
                margin-bottom: 10px;
            }

            #preset-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 5px;
                margin-top: 10px;
            }

            #preset-buttons button {
                padding: 8px;
                font-size: 11px;
            }
        </style>
    </head>

    <body>
        <div id="canvas-container"></div>
        <div id="controls">
            <h1 style="margin-top: 0; font-size: 18px">Analog Glitch Art</h1>

            <div class="control-group">
                <h2>Canvas Settings</h2>
                <select id="canvas-size" onchange="updateCanvasSize()">
                    <option value="a4">A4 (Portrait)</option>
                    <option value="a3">A3 (Portrait)</option>
                    <option value="a2">A2 (Portrait)</option>
                    <option value="a1">A1 (Portrait)</option>
                    <option value="4k">4K Wallpaper (3840x2160)</option>
                    <option value="screen" selected>Screen (800x1000)</option>
                </select>
            </div>

            <div class="control-group">
                <h2>Presets</h2>
                <div id="preset-buttons">
                    <button class="secondary" onclick="loadPreset('scan')">
                        Scan Damage
                    </button>
                    <button class="secondary" onclick="loadPreset('fax')">
                        Fax Error
                    </button>
                    <button class="secondary" onclick="loadPreset('thermal')">
                        Thermal Print
                    </button>
                    <button class="secondary" onclick="loadPreset('ocr')">
                        OCR Fail
                    </button>
                    <button class="secondary" onclick="loadPreset('heavy')">
                        Heavy Glitch
                    </button>
                    <button class="secondary" onclick="loadPreset('subtle')">
                        Subtle Noise
                    </button>
                </div>
            </div>

            <div class="control-group">
                <h2>Character Settings</h2>
                <label>
                    Density
                    <span class="value-display" id="density-val">30%</span>
                    <input
                        type="range"
                        id="density"
                        min="5"
                        max="100"
                        value="30"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Corruption Level
                    <span class="value-display" id="corruption-val">70%</span>
                    <input
                        type="range"
                        id="corruption"
                        min="0"
                        max="100"
                        value="70"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Font Size
                    <span class="value-display" id="fontsize-val">12</span>
                    <input
                        type="range"
                        id="fontsize"
                        min="6"
                        max="24"
                        value="12"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Size Variation
                    <span class="value-display" id="sizevar-val">50%</span>
                    <input
                        type="range"
                        id="sizevar"
                        min="0"
                        max="100"
                        value="50"
                        oninput="updateConfig()"
                    />
                </label>
            </div>

            <div class="control-group">
                <h2>Repetition Effects</h2>
                <label>
                    Horizontal Repetition
                    <span class="value-display" id="rep-horiz-val">20%</span>
                    <input
                        type="range"
                        id="rep-horiz"
                        min="0"
                        max="100"
                        value="20"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Vertical Repetition
                    <span class="value-display" id="rep-vert-val">20%</span>
                    <input
                        type="range"
                        id="rep-vert"
                        min="0"
                        max="100"
                        value="20"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Diagonal Repetition
                    <span class="value-display" id="rep-diag-val">20%</span>
                    <input
                        type="range"
                        id="rep-diag"
                        min="0"
                        max="100"
                        value="20"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Repetition Length
                    <span class="value-display" id="replength-val">3</span>
                    <input
                        type="range"
                        id="replength"
                        min="2"
                        max="8"
                        value="3"
                        oninput="updateConfig()"
                    />
                </label>
            </div>

            <div class="control-group">
                <h2>Spatial Effects</h2>
                <label>
                    Position Drift
                    <span class="value-display" id="drift-val">50%</span>
                    <input
                        type="range"
                        id="drift"
                        min="0"
                        max="100"
                        value="50"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Cluster Strength
                    <span class="value-display" id="cluster-val">40%</span>
                    <input
                        type="range"
                        id="cluster"
                        min="0"
                        max="100"
                        value="40"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Edge Bias (Center ‚Üî Edge)
                    <span class="value-display" id="edgebias-val">50%</span>
                    <input
                        type="range"
                        id="edgebias"
                        min="0"
                        max="100"
                        value="50"
                        oninput="updateConfig()"
                    />
                </label>
            </div>

            <div class="control-group">
                <h2>Character Sets</h2>
                <div class="checkbox-group">
                    <label
                        ><input
                            type="checkbox"
                            id="set-latin"
                            checked
                            onchange="updateConfig()"
                        />
                        Latin Letters</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-numbers"
                            checked
                            onchange="updateConfig()"
                        />
                        Numbers</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-symbols"
                            checked
                            onchange="updateConfig()"
                        />
                        Symbols</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-cyrillic"
                            onchange="updateConfig()"
                        />
                        Cyrillic</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-special"
                            onchange="updateConfig()"
                        />
                        Special Unicode</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-corruption"
                            checked
                            onchange="updateConfig()"
                        />
                        Box Characters</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-walls"
                            checked
                            onchange="updateConfig()"
                        />
                        Walls (Lines)</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-custom"
                            onchange="updateConfig()"
                        />
                        Custom:</label
                    >
                    <input
                        type="text"
                        id="custom-chars"
                        placeholder="Enter custom chars"
                        oninput="updateConfig()"
                        style="
                            width: 100%;
                            margin-top: 5px;
                            background: #333;
                            border: 1px solid #555;
                            color: white;
                            padding: 4px;
                        "
                    />
                </div>
            </div>

            <div class="control-group">
                <h2>Horizontal Lines</h2>
                <label
                    ><input
                        type="checkbox"
                        id="effect-horiz-lines"
                        onchange="updateConfig()"
                    />
                    Enable Horizontal Lines</label
                >

                <div
                    id="horiz-lines-controls"
                    style="
                        margin-top: 10px;
                        padding-left: 10px;
                        border-left: 2px solid #ddd;
                    "
                >
                    <label>
                        Density
                        <span class="value-display" id="horiz-density-val"
                            >50%</span
                        >
                        <input
                            type="range"
                            id="horiz-density"
                            min="1"
                            max="100"
                            value="50"
                            oninput="updateConfig()"
                        />
                    </label>
                    <label>
                        Max Length
                        <span class="value-display" id="horiz-length-val"
                            >50%</span
                        >
                        <input
                            type="range"
                            id="horiz-length"
                            min="10"
                            max="100"
                            value="50"
                            oninput="updateConfig()"
                        />
                    </label>
                    <label>
                        Character Set:
                        <select
                            id="horiz-charset"
                            onchange="updateConfig()"
                            style="width: 100%; margin-top: 5px"
                        >
                            <option value="walls">Walls (Lines)</option>
                            <option value="corruption">
                                Corruption Blocks
                            </option>
                            <option value="latin">Latin Text</option>
                            <option value="mixed">Mixed Random</option>
                        </select>
                    </label>
                </div>
            </div>

            <div class="control-group">
                <h2>Visual Artifacts</h2>
                <div class="checkbox-group">
                    <label
                        ><input
                            type="checkbox"
                            id="effect-stains"
                            onchange="updateConfig()"
                        />
                        Photocopier Stains</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="effect-noise"
                            checked
                            onchange="updateConfig()"
                        />
                        Background Noise</label
                    >
                </div>
            </div>

            <div class="control-group">
                <h2>Glitch Effects</h2>
                <div class="checkbox-group">
                    <label
                        ><input
                            type="checkbox"
                            id="effect-scanlines"
                            checked
                            onchange="updateConfig()"
                        />
                        Scan Lines</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="effect-ghosting"
                            checked
                            onchange="updateConfig()"
                        />
                        Character Ghosting</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="effect-blocks"
                            checked
                            onchange="updateConfig()"
                        />
                        Compression Blocks</label
                    >
                </div>
            </div>

            <div class="control-group">
                <h2>Source Document (Optional)</h2>
                <div class="checkbox-group">
                    <label
                        ><input
                            type="checkbox"
                            id="use-source"
                            onchange="updateConfig()"
                        />
                        Use Source Text</label
                    >
                </div>
                <textarea
                    id="source-text"
                    placeholder="Paste text here to glitch an actual document..."
                ></textarea>
            </div>

            <div class="control-group">
                <button onclick="regenerate()">‚ü≥ Regenerate</button>
                <button onclick="saveImage()" class="secondary">
                    üíæ Save Image
                </button>
                <button onclick="randomize()" class="secondary">
                    üé≤ Randomize All
                </button>
            </div>
        </div>
        <script>
            // Configuration object
            let config = {
                density: 0.3,
                corruptionLevel: 0.7,
                repetitionHoriz: 0.2,
                repetitionVert: 0.2,
                repetitionDiag: 0.2,
                repetitionLength: 3,
                sizeVariation: 0.5,
                clusterStrength: 0.4,
                positionDrift: 0.5,
                edgeBias: 0.5,
                baseFontSize: 12,
                useSourceDoc: false,
                sourceText: "",

                // New Settings
                horizLinesDensity: 0.5,
                horizLinesLength: 0.5,
                horizLinesCharSet: "walls",

                charSets: {
                    latin: true,
                    numbers: true,
                    symbols: true,
                    cyrillic: false,
                    special: false,
                    corruption: true,
                    walls: true,
                    custom: false,
                    customChars: "",
                },
                effects: {
                    scanlines: true,
                    ghosting: true,
                    blocks: true,
                    horizLines: false,
                    stains: false,
                    noise: true,
                },
            };

            // Character set definitions
            const charSets = {
                latin: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",
                numbers: "0123456789",
                symbols: "!@#$%^&*(){}[]|\\/<>~`-_=+;:'\",.",
                cyrillic:
                    "–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è",
                special: "‚Üí‚Üê‚Üë‚Üì‚àû‚âà‚â†¬±√ó√∑¬ß¬∂‚Ä†‚Ä°¬©¬Æ‚Ñ¢‚Ç¨¬£¬•¬¢¬∞‚Ä¢¬∑‚Ä¶\"\"''‚Äî‚Äì",
                corruption: "‚ñì‚ñí‚ñë‚ñà‚ñÑ‚ñÄ‚ñ†‚ñ°‚óè‚óã‚óÜ‚óá‚ñ™‚ñ´",
                walls: "‚ïë‚îÇ‚îÉ‚îÇ‚ñê‚ñç‚ñé‚ñè‚ñå‚îÇ‚ïë‚îÇ‚îÉ‚îÇ‚îå‚îê‚îî‚îò‚ïî‚ïó‚ïö‚ïù‚ï†‚ï£‚ï¶‚ï©‚ï¨‚îº‚ïê‚îÄ",
            };

            function randomChar(str) {
                if (!str || str.length === 0) return " ";
                return str.charAt(floor(random(str.length)));
            }

            let glitchPositions = [];
            let canvasWidth = 800;
            let canvasHeight = 1000;

            function setup() {
                let canvas = createCanvas(canvasWidth, canvasHeight);
                canvas.parent("canvas-container");
                textFont("Special Elite");

                regenerate();
            }

            function draw() {
                // Static image
            }

            window.updateCanvasSize = function () {
                let mode = document.getElementById("canvas-size").value;

                if (mode === "screen") {
                    canvasWidth = 800;
                    canvasHeight = 1000;
                } else if (mode === "a4") {
                    canvasWidth = 595;
                    canvasHeight = 842;
                } else if (mode === "a3") {
                    canvasWidth = 842;
                    canvasHeight = 1191;
                } else if (mode === "a2") {
                    canvasWidth = 1191;
                    canvasHeight = 1684;
                } else if (mode === "a1") {
                    canvasWidth = 1684;
                    canvasHeight = 2384;
                } else if (mode === "4k") {
                    canvasWidth = 3840;
                    canvasHeight = 2160;
                }

                resizeCanvas(canvasWidth, canvasHeight);
                regenerate();
            };

            function regenerate() {
                background(255);

                // 1. Background Noise (Bottom Layer)
                if (config.effects.noise) {
                    drawBackgroundNoise();
                }

                // 2. Photocopier Stains
                if (config.effects.stains) {
                    drawStains();
                }

                // 3. Generate Character Positions
                glitchPositions = config.useSourceDoc
                    ? generateFromSource()
                    : generateRandomPositions();

                // 4. Ghosting (Behind Text)
                if (config.effects.ghosting) {
                    drawGhosting();
                }

                // 5. Main Text
                drawCharacters();

                // 6. Top Layer Effects
                if (config.effects.horizLines) {
                    drawHorizontalLines();
                }

                if (config.effects.scanlines) {
                    drawScanlines();
                }

                if (config.effects.blocks) {
                    drawCompressionBlocks();
                }
            }

            function generateRandomPositions() {
                let positions = [];
                let charPool = getActiveCharPool();
                if (charPool.length === 0) charPool = ["X"];

                noiseSeed(random(10000));
                let gridSpacing = config.baseFontSize * 1.2;

                for (let y = 0; y < height; y += gridSpacing) {
                    for (let x = 0; x < width; x += gridSpacing) {
                        let noiseVal = noise(x * 0.005, y * 0.005);

                        let normalizedX = x / width;
                        let distFromCenter = abs(normalizedX - 0.5) * 2;
                        let biasFactor = 1;
                        if (config.edgeBias > 0.5) {
                            let strength = map(config.edgeBias, 0.5, 1, 0, 1);
                            biasFactor = map(
                                distFromCenter,
                                0,
                                1,
                                1 - strength,
                                1 + strength,
                            );
                        } else {
                            let strength = map(config.edgeBias, 0.5, 0, 0, 1);
                            biasFactor = map(
                                distFromCenter,
                                0,
                                1,
                                1 + strength,
                                1 - strength,
                            );
                        }
                        noiseVal *= biasFactor;

                        let densityThreshold = 1 - config.density;
                        let clusterMod = map(
                            config.clusterStrength,
                            0,
                            1,
                            0.5,
                            1.5,
                        );
                        noiseVal = pow(noiseVal, clusterMod);

                        if (noiseVal > densityThreshold) {
                            let driftX = randomGaussian(
                                0,
                                config.positionDrift * 15,
                            );
                            let driftY = randomGaussian(
                                0,
                                config.positionDrift * 8,
                            );
                            let char = randomChar(charPool.join(""));

                            positions.push({
                                x: x + driftX,
                                y: y + driftY,
                                char: char,
                                size:
                                    config.baseFontSize *
                                    random(
                                        1 - config.sizeVariation,
                                        1 + config.sizeVariation,
                                    ),
                                opacity: random(180, 255),
                            });

                            if (random() < config.repetitionHoriz) {
                                let repeatCount = floor(
                                    random(2, config.repetitionLength + 1),
                                );
                                for (let r = 1; r <= repeatCount; r++) {
                                    positions.push({
                                        x: x + driftX + r * gridSpacing * 0.8,
                                        y: y + driftY,
                                        char: char,
                                        size:
                                            config.baseFontSize *
                                            random(
                                                1 - config.sizeVariation * 0.5,
                                                1 + config.sizeVariation * 0.5,
                                            ),
                                        opacity: random(150, 255),
                                    });
                                }
                            }
                            if (random() < config.repetitionVert) {
                                let repeatCount = floor(
                                    random(2, config.repetitionLength + 1),
                                );
                                for (let r = 1; r <= repeatCount; r++) {
                                    positions.push({
                                        x: x + driftX,
                                        y: y + driftY + r * gridSpacing * 0.8,
                                        char: char,
                                        size:
                                            config.baseFontSize *
                                            random(
                                                1 - config.sizeVariation * 0.5,
                                                1 + config.sizeVariation * 0.5,
                                            ),
                                        opacity: random(150, 255),
                                    });
                                }
                            }
                            if (random() < config.repetitionDiag) {
                                let repeatCount = floor(
                                    random(2, config.repetitionLength + 1),
                                );
                                let diagDir = random() < 0.5 ? 1 : -1;
                                for (let r = 1; r <= repeatCount; r++) {
                                    positions.push({
                                        x:
                                            x +
                                            driftX +
                                            diagDir * r * gridSpacing * 0.6,
                                        y: y + driftY + r * gridSpacing * 0.6,
                                        char: char,
                                        size:
                                            config.baseFontSize *
                                            random(
                                                1 - config.sizeVariation * 0.5,
                                                1 + config.sizeVariation * 0.5,
                                            ),
                                        opacity: random(150, 255),
                                    });
                                }
                            }
                        }
                    }
                }
                return positions;
            }

            function generateFromSource() {
                let positions = [];
                let charPool = getActiveCharPool();
                let text = config.sourceText || "NO SOURCE TEXT PROVIDED";
                let chars = text.split("");

                let x = 50;
                let y = 50;
                let lineHeight = config.baseFontSize * 1.8;
                let charWidth = config.baseFontSize * 0.7;

                for (let i = 0; i < chars.length; i++) {
                    let char = chars[i];
                    if (char === "\n") {
                        x = 50;
                        y += lineHeight;
                        continue;
                    }

                    if (random() < config.corruptionLevel)
                        char = random(charPool);

                    let driftX = randomGaussian(0, config.corruptionLevel * 20);
                    let driftY = randomGaussian(0, config.corruptionLevel * 10);

                    positions.push({
                        x: x + driftX,
                        y: y + driftY,
                        char: char,
                        size:
                            config.baseFontSize *
                            random(
                                1 - config.sizeVariation * 0.5,
                                1 + config.sizeVariation * 0.5,
                            ),
                        opacity: random(150, 255),
                    });

                    x += charWidth;
                    if (x > width - 100) {
                        x = 50;
                        y += lineHeight;
                    }
                    if (y > height - 50) break;
                }
                return positions;
            }

            function drawCharacters() {
                fill(0);
                noStroke();
                for (let p of glitchPositions) {
                    push();
                    translate(p.x, p.y);
                    textSize(p.size);
                    fill(0, p.opacity);
                    textAlign(CENTER, CENTER);
                    text(p.char, 0, 0);
                    pop();
                }
            }

            function drawGhosting() {
                fill(0, 50);
                noStroke();
                for (let p of glitchPositions) {
                    if (random() < 0.15) {
                        let ghostCount = floor(random(1, 4));
                        for (let i = 0; i < ghostCount; i++) {
                            push();
                            translate(p.x + random(-5, 5), p.y + random(-5, 5));
                            textSize(p.size);
                            textAlign(CENTER, CENTER);
                            text(p.char, 0, 0);
                            pop();
                        }
                    }
                }
            }

            function drawScanlines() {
                stroke(0, random(20, 40));
                strokeWeight(random(0.5, 1.5));
                for (let y = 0; y < height; y += random(3, 12)) {
                    let x1 = random(-20, 0);
                    let x2 = width + random(0, 20);
                    line(x1, y, x2, y);
                }
            }

            function drawCompressionBlocks() {
                noStroke();
                for (let i = 0; i < 30; i++) {
                    fill(0, random(10, 50));
                    rect(
                        random(width),
                        random(height),
                        random(10, 80),
                        random(5, 30),
                    );
                }
                for (let i = 0; i < 15; i++) {
                    fill(255, random(100, 200));
                    rect(
                        random(width),
                        random(height),
                        random(5, 40),
                        random(3, 15),
                    );
                }
            }

            // --- NEW: Stains Effects ---
            // --- NEW: Stains Effects (V8 - Softened "Melted" Toner Blasts) ---
            function drawStains() {
                noStroke();
                let numStains = floor(random(3, 8)); // Low count

                for (let i = 0; i < numStains; i++) {
                    let w = floor(random(50, 400));
                    let h = floor(random(100, 500));

                    let pg = createGraphics(w, h);

                    // PASS 1: The Smudge (Faint Toner Dust)
                    pg.loadPixels();
                    let noiseOffsetX = random(1000);
                    let noiseOffsetY = random(1000);
                    let baseAlpha = random(10, 40);

                    for (let y = 0; y < h; y++) {
                        for (let x = 0; x < w; x++) {
                            let index = (x + y * w) * 4;
                            let nShape = noise(
                                x * 0.05 + noiseOffsetX,
                                y * 0.01 + noiseOffsetY,
                            );

                            let dx = x - w / 2;
                            let dy = y - h / 2;
                            let distNorm =
                                (dx * dx) / (w * w * 0.25) +
                                (dy * dy) / (h * h * 0.25);
                            let maskVal = nShape * (1 - distNorm * 0.5);

                            if (maskVal > 0.4) {
                                // Gray Smudge
                                let a =
                                    baseAlpha + noise(x * 0.1, y * 0.1) * 30;
                                pg.pixels[index] = 30; // Dark Gray
                                pg.pixels[index + 1] = 30;
                                pg.pixels[index + 2] = 30;
                                pg.pixels[index + 3] = a;
                            }
                        }
                    }
                    pg.updatePixels();
                    // V8: Soften the squares into organic blobs
                    pg.filter(BLUR, 1.2);

                    // PASS 2: The Toner Blast (Micro-Grit)
                    pg.fill(0); // SOLID BLACK
                    pg.noStroke();

                    // V8: Smaller grit (2-3px) for "powder" look
                    let step = 3;

                    for (let y = 0; y < h; y += step) {
                        for (let x = 0; x < w; x += step) {
                            let nGrit = noise(
                                x * 0.15 + noiseOffsetX,
                                y * 0.15 + noiseOffsetY,
                            );

                            let nShape = noise(
                                x * 0.05 + noiseOffsetX,
                                y * 0.01 + noiseOffsetY,
                            );
                            let dx = x - w / 2;
                            let dy = y - h / 2;
                            let distNorm =
                                (dx * dx) / (w * w * 0.25) +
                                (dy * dy) / (h * h * 0.25);
                            let maskVal = nShape * (1 - distNorm * 0.5);

                            // V8 Logic: Gaps in the grit (nGrit > 0.45)
                            if (maskVal > 0.42 && nGrit > 0.45) {
                                let size = random(2, 4); // 2px-4px
                                pg.rect(
                                    x + random(-2, 2),
                                    y + random(-2, 2),
                                    size,
                                    size,
                                );
                            }

                            // Edge Spray (Dense border)
                            let isEdge = maskVal > 0.38 && maskVal < 0.45;
                            if (isEdge && random() < 0.35) {
                                pg.rect(x, y, 2, 2);
                            }
                        }
                    }

                    // Place the stain patch
                    let placeX = random(width);
                    // Bias: Middle or Edges
                    if (random() < 0.3) placeX = width / 2 + random(-200, 200);

                    let placeY = random(height);
                    image(pg, placeX - w / 2, placeY - h / 2);
                    pg.remove();
                }
            }

            // --- NEW: Horizontal Lines ---
            function drawHorizontalLines() {
                fill(0);
                noStroke();
                textSize(config.baseFontSize);

                // Select Char Pool for Lines
                let pool = "";
                switch (config.horizLinesCharSet) {
                    case "walls":
                        pool = charSets.walls;
                        break;
                    case "corruption":
                        pool = charSets.corruption;
                        break;
                    case "latin":
                        pool = charSets.latin;
                        break;
                    case "mixed":
                        pool = getActiveCharPool().join("");
                        break;
                    default:
                        pool = charSets.walls;
                }

                // Density controls count
                let numLines = floor(
                    map(config.horizLinesDensity, 0, 1, 1, 50),
                );

                for (let i = 0; i < numLines; i++) {
                    let y = random(10, height - 10);
                    let char = randomChar(pool);

                    // Length control
                    let maxChars = width / (config.baseFontSize * 0.6);
                    let lineLengthPercent = map(
                        config.horizLinesLength,
                        0,
                        1,
                        0.05,
                        1.0,
                    );
                    let lineLen = floor(
                        random(2, maxChars * lineLengthPercent),
                    );

                    let lineStr = "";
                    for (let k = 0; k < lineLen; k++) lineStr += char;

                    fill(0, random(150, 255));

                    // Random horizontal placement logic
                    if (lineLen > maxChars * 0.9) {
                        // Full width-ish
                        textAlign(CENTER, CENTER);
                        text(lineStr, width / 2, y);
                    } else {
                        // Random placement
                        let startX = random(
                            0,
                            width - lineLen * config.baseFontSize * 0.6,
                        );
                        textAlign(LEFT, CENTER);
                        text(lineStr, startX, y);
                    }
                }
            }

            function drawBackgroundNoise() {
                loadPixels();
                // Increase probability slightly if it's too subtle, or darken it
                for (let i = 0; i < pixels.length; i += 4) {
                    if (random() < 0.03) {
                        // 3% of pixels
                        let shade = random(150, 230); // Darker noise spots
                        pixels[i] = shade;
                        pixels[i + 1] = shade;
                        pixels[i + 2] = shade;
                        // pixels[i+3] is alpha, leave 255
                    }
                }
                updatePixels();
            }

            // Helper: pool
            function getActiveCharPool() {
                let pool = "";
                if (config.charSets.latin) pool += charSets.latin;
                if (config.charSets.numbers) pool += charSets.numbers;
                if (config.charSets.symbols) pool += charSets.symbols;
                if (config.charSets.cyrillic) pool += charSets.cyrillic;
                if (config.charSets.special) pool += charSets.special;
                if (config.charSets.corruption) pool += charSets.corruption;
                if (config.charSets.walls) pool += charSets.walls;
                if (config.charSets.custom && config.charSets.customChars)
                    pool += config.charSets.customChars;
                return pool.split("");
            }

            window.updateConfig = function () {
                // 1. Basic Sliders
                config.density = document.getElementById("density").value / 100;
                config.corruptionLevel =
                    document.getElementById("corruption").value / 100;
                config.baseFontSize = parseInt(
                    document.getElementById("fontsize").value,
                );
                config.sizeVariation =
                    document.getElementById("sizevar").value / 100;

                config.repetitionHoriz =
                    document.getElementById("rep-horiz").value / 100;
                config.repetitionVert =
                    document.getElementById("rep-vert").value / 100;
                config.repetitionDiag =
                    document.getElementById("rep-diag").value / 100;
                config.repetitionLength = parseInt(
                    document.getElementById("replength").value,
                );

                config.positionDrift =
                    document.getElementById("drift").value / 100;
                config.clusterStrength =
                    document.getElementById("cluster").value / 100;
                config.edgeBias =
                    document.getElementById("edgebias").value / 100;

                // 2. New Horizontal Line Controls
                config.horizLinesDensity =
                    document.getElementById("horiz-density").value / 100;
                config.horizLinesLength =
                    document.getElementById("horiz-length").value / 100;
                config.horizLinesCharSet =
                    document.getElementById("horiz-charset").value;

                // 3. Effects Checkboxes
                config.effects.horizLines =
                    document.getElementById("effect-horiz-lines").checked;
                config.effects.stains =
                    document.getElementById("effect-stains").checked;
                config.effects.noise =
                    document.getElementById("effect-noise").checked;
                config.effects.scanlines =
                    document.getElementById("effect-scanlines").checked;
                config.effects.ghosting =
                    document.getElementById("effect-ghosting").checked;
                config.effects.blocks =
                    document.getElementById("effect-blocks").checked;

                // 4. Update Displays
                document.getElementById("density-val").textContent =
                    document.getElementById("density").value + "%";
                document.getElementById("corruption-val").textContent =
                    document.getElementById("corruption").value + "%";
                document.getElementById("fontsize-val").textContent =
                    document.getElementById("fontsize").value;
                document.getElementById("sizevar-val").textContent =
                    document.getElementById("sizevar").value + "%";
                document.getElementById("rep-horiz-val").textContent =
                    document.getElementById("rep-horiz").value + "%";
                document.getElementById("rep-vert-val").textContent =
                    document.getElementById("rep-vert").value + "%";
                document.getElementById("rep-diag-val").textContent =
                    document.getElementById("rep-diag").value + "%";
                document.getElementById("replength-val").textContent =
                    document.getElementById("replength").value;
                document.getElementById("drift-val").textContent =
                    document.getElementById("drift").value + "%";
                document.getElementById("cluster-val").textContent =
                    document.getElementById("cluster").value + "%";
                document.getElementById("edgebias-val").textContent =
                    document.getElementById("edgebias").value + "%";

                document.getElementById("horiz-density-val").textContent =
                    document.getElementById("horiz-density").value + "%";
                document.getElementById("horiz-length-val").textContent =
                    document.getElementById("horiz-length").value + "%";

                // 5. Char sets
                config.charSets.latin =
                    document.getElementById("set-latin").checked;
                config.charSets.numbers =
                    document.getElementById("set-numbers").checked;
                config.charSets.symbols =
                    document.getElementById("set-symbols").checked;
                config.charSets.cyrillic =
                    document.getElementById("set-cyrillic").checked;
                config.charSets.special =
                    document.getElementById("set-special").checked;
                config.charSets.corruption =
                    document.getElementById("set-corruption").checked;
                config.charSets.walls =
                    document.getElementById("set-walls").checked;
                config.charSets.custom =
                    document.getElementById("set-custom").checked;
                config.charSets.customChars =
                    document.getElementById("custom-chars").value;

                // 6. Source
                config.useSourceDoc =
                    document.getElementById("use-source").checked;
                config.sourceText =
                    document.getElementById("source-text").value;

                regenerate();
            };

            function saveImage() {
                saveCanvas("glitch-art-" + Date.now(), "png");
            }

            function randomize() {
                let ids = [
                    "density",
                    "corruption",
                    "rep-horiz",
                    "rep-vert",
                    "rep-diag",
                    "sizevar",
                    "cluster",
                    "drift",
                    "edgebias",
                    "horiz-density",
                    "horiz-length",
                ];
                for (let id of ids)
                    document.getElementById(id).value = floor(random(10, 90));

                document.getElementById("fontsize").value = floor(
                    random(8, 16),
                );
                document.getElementById("replength").value = floor(
                    random(2, 6),
                );

                // Randomize some char sets
                document.getElementById("set-walls").checked = random() > 0.5;
                document.getElementById("set-corruption").checked =
                    random() > 0.5;
                document.getElementById("set-latin").checked = random() > 0.5;
                document.getElementById("set-numbers").checked = random() > 0.5;
                document.getElementById("set-symbols").checked = random() > 0.5;

                // Randomize effects
                document.getElementById("effect-scanlines").checked =
                    random() > 0.5;
                document.getElementById("effect-ghosting").checked =
                    random() > 0.5;
                document.getElementById("effect-blocks").checked =
                    random() > 0.5;
                document.getElementById("effect-stains").checked =
                    random() > 0.5;
                document.getElementById("effect-horiz-lines").checked =
                    random() > 0.5;
                document.getElementById("effect-noise").checked =
                    random() > 0.5;

                // Randomize horizontal line charset
                const charSetOptions = [
                    "walls",
                    "corruption",
                    "latin",
                    "mixed",
                ];
                document.getElementById("horiz-charset").value =
                    random(charSetOptions);

                updateConfig();
            }

            function loadPreset(presetName) {
                const presets = {
                    scan: {
                        density: 35,
                        corruption: 60,
                        repHoriz: 30,
                        repVert: 15,
                        repDiag: 10,
                        replength: 3,
                        sizevar: 30,
                        cluster: 20,
                        drift: 40,
                        edgebias: 50,
                        fontsize: 11,
                        scanlines: true,
                        ghosting: false,
                        blocks: true,
                        horizLines: false,
                        stains: false,
                        noise: true,
                        horizLinesDensity: 50,
                        horizLinesLength: 50,
                        horizLinesCharSet: "walls",
                    },
                    fax: {
                        density: 50,
                        corruption: 80,
                        repHoriz: 40,
                        repVert: 40,
                        repDiag: 30,
                        replength: 4,
                        sizevar: 20,
                        cluster: 60,
                        drift: 70,
                        edgebias: 80,
                        fontsize: 10,
                        scanlines: true,
                        ghosting: true,
                        blocks: false,
                        horizLines: true,
                        stains: true,
                        noise: true,
                        horizLinesDensity: 80,
                        horizLinesLength: 80,
                        horizLinesCharSet: "corruption",
                    },
                    thermal: {
                        density: 40,
                        corruption: 50,
                        repHoriz: 10,
                        repVert: 20,
                        repDiag: 5,
                        replength: 3,
                        sizevar: 40,
                        cluster: 30,
                        drift: 20,
                        edgebias: 20,
                        fontsize: 9,
                        scanlines: false,
                        ghosting: true,
                        blocks: true,
                        horizLines: false,
                        stains: false,
                        noise: false,
                        horizLinesDensity: 30,
                        horizLinesLength: 30,
                        horizLinesCharSet: "latin",
                    },
                    ocr: {
                        density: 60,
                        corruption: 90,
                        repHoriz: 15,
                        repVert: 10,
                        repDiag: 5,
                        replength: 2,
                        sizevar: 60,
                        cluster: 10,
                        drift: 80,
                        edgebias: 50,
                        fontsize: 12,
                        scanlines: false,
                        ghosting: false,
                        blocks: false,
                        horizLines: false,
                        stains: false,
                        noise: true,
                        horizLinesDensity: 50,
                        horizLinesLength: 50,
                        horizLinesCharSet: "mixed",
                    },
                    heavy: {
                        density: 70,
                        corruption: 95,
                        repHoriz: 50,
                        repVert: 50,
                        repDiag: 50,
                        replength: 6,
                        sizevar: 80,
                        cluster: 70,
                        drift: 90,
                        edgebias: 50,
                        fontsize: 14,
                        scanlines: true,
                        ghosting: true,
                        blocks: true,
                        horizLines: true,
                        stains: true,
                        noise: true,
                        horizLinesDensity: 90,
                        horizLinesLength: 90,
                        horizLinesCharSet: "walls",
                    },
                    subtle: {
                        density: 20,
                        corruption: 30,
                        repHoriz: 5,
                        repVert: 8,
                        repDiag: 3,
                        replength: 2,
                        sizevar: 20,
                        cluster: 40,
                        drift: 25,
                        edgebias: 50,
                        fontsize: 10,
                        scanlines: false,
                        ghosting: false,
                        blocks: false,
                        horizLines: false,
                        stains: false,
                        noise: true,
                        horizLinesDensity: 20,
                        horizLinesLength: 20,
                        horizLinesCharSet: "latin",
                    },
                };

                const preset = presets[presetName];
                if (!preset) return;

                document.getElementById("density").value = preset.density;
                document.getElementById("corruption").value = preset.corruption;
                document.getElementById("rep-horiz").value = preset.repHoriz;
                document.getElementById("rep-vert").value = preset.repVert;
                document.getElementById("rep-diag").value = preset.repDiag;
                document.getElementById("replength").value = preset.replength;
                document.getElementById("sizevar").value = preset.sizevar;
                document.getElementById("cluster").value = preset.cluster;
                document.getElementById("drift").value = preset.drift;
                document.getElementById("edgebias").value =
                    preset.edgebias || 50;
                document.getElementById("fontsize").value = preset.fontsize;

                document.getElementById("horiz-density").value =
                    preset.horizLinesDensity;
                document.getElementById("horiz-length").value =
                    preset.horizLinesLength;
                document.getElementById("horiz-charset").value =
                    preset.horizLinesCharSet;

                document.getElementById("effect-scanlines").checked =
                    preset.scanlines;
                document.getElementById("effect-ghosting").checked =
                    preset.ghosting;
                document.getElementById("effect-blocks").checked =
                    preset.blocks;
                document.getElementById("effect-horiz-lines").checked =
                    preset.horizLines;
                document.getElementById("effect-stains").checked =
                    preset.stains;
                document.getElementById("effect-noise").checked = preset.noise;

                updateConfig();
            }
        </script>
    </body>
</html>
