<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Printer glitch</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                margin: 0;
                padding: 20px;
                font-family: "Special Elite", "Courier New", monospace;
                background: #1a1a1a;
                color: #ffffff;
                display: flex;
                gap: 20px;
            }

            #canvas-container {
                flex: 1;
                background: white;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                display: flex;
                justify-content: center;
                align-items: flex-start;
                overflow: auto;
            }

            #controls {
                width: 320px;
                background: #2a2a2a;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                height: fit-content;
                max-height: 90vh;
                overflow-y: auto;
            }

            .control-group {
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 1px solid #444;
            }

            .control-group:last-child {
                border-bottom: none;
            }

            h2 {
                margin: 0 0 15px 0;
                font-size: 14px;
                text-transform: uppercase;
                color: #888;
                letter-spacing: 1px;
            }

            label {
                display: block;
                margin-bottom: 8px;
                font-size: 12px;
                color: #aaa;
            }

            input[type="range"] {
                width: 100%;
                margin-bottom: 5px;
            }

            input[type="checkbox"] {
                margin-right: 8px;
            }

            button {
                width: 100%;
                padding: 12px;
                margin: 5px 0;
                background: #4a9eff;
                border: none;
                color: white;
                font-family: "Special Elite", "Courier New", monospace;
                font-size: 13px;
                cursor: pointer;
                border-radius: 4px;
                transition: background 0.2s;
            }

            button:hover {
                background: #357abd;
            }

            button.secondary {
                background: #555;
            }

            button.secondary:hover {
                background: #666;
            }

            button.mini {
                width: auto;
                padding: 4px 8px;
                font-size: 10px;
                margin-left: 8px;
                display: inline-block;
                background: #666;
            }

            button.mini:hover {
                background: #777;
            }

            .value-display {
                float: right;
                color: #4a9eff;
                font-weight: bold;
            }

            textarea {
                width: 100%;
                height: 100px;
                background: #1a1a1a;
                border: 1px solid #444;
                color: #fff;
                font-family: "Special Elite", "Courier New", monospace;
                font-size: 11px;
                padding: 8px;
                box-sizing: border-box;
                resize: vertical;
            }

            .checkbox-group {
                margin: 8px 0;
            }

            .checkbox-with-regen {
                display: flex;
                align-items: center;
                margin-bottom: 8px;
            }

            .checkbox-with-regen label {
                margin: 0;
                flex: 1;
            }

            select {
                width: 100%;
                padding: 8px;
                background: #1a1a1a;
                border: 1px solid #444;
                color: #fff;
                font-family: "Special Elite", "Courier New", monospace;
                font-size: 12px;
                margin-bottom: 10px;
            }
        </style>
    </head>

    <body>
        <div id="canvas-container"></div>
        <div id="controls">
            <h1 style="margin-top: 0; font-size: 18px">Printer Glitch</h1>

            <div class="control-group">
                <h2>Canvas Settings</h2>
                <select id="canvas-size" onchange="updateCanvasSize()">
                    <option value="a4">A4 (Portrait)</option>
                    <option value="a3">A3 (Portrait)</option>
                    <option value="a2">A2 (Portrait)</option>
                    <option value="a1">A1 (Portrait)</option>
                    <option value="4k">4K Wallpaper (3840x2160)</option>
                    <option value="screen" selected>Screen (800x1000)</option>
                </select>
            </div>

            <div class="control-group">
                <h2>Character Settings</h2>
                <label>
                    Density
                    <span class="value-display" id="density-val">30%</span>
                    <input
                        type="range"
                        id="density"
                        min="5"
                        max="100"
                        value="30"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Corruption Level
                    <span class="value-display" id="corruption-val">70%</span>
                    <input
                        type="range"
                        id="corruption"
                        min="0"
                        max="100"
                        value="70"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Font Size
                    <span class="value-display" id="fontsize-val">12</span>
                    <input
                        type="range"
                        id="fontsize"
                        min="6"
                        max="24"
                        value="12"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Size Variation
                    <span class="value-display" id="sizevar-val">50%</span>
                    <input
                        type="range"
                        id="sizevar"
                        min="0"
                        max="100"
                        value="50"
                        oninput="updateConfig()"
                    />
                </label>
            </div>

            <div class="control-group">
                <h2>Repetition Effects</h2>
                <label>
                    Horizontal Repetition
                    <span class="value-display" id="rep-horiz-val">20%</span>
                    <input
                        type="range"
                        id="rep-horiz"
                        min="0"
                        max="100"
                        value="20"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Vertical Repetition
                    <span class="value-display" id="rep-vert-val">20%</span>
                    <input
                        type="range"
                        id="rep-vert"
                        min="0"
                        max="100"
                        value="20"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Diagonal Repetition
                    <span class="value-display" id="rep-diag-val">20%</span>
                    <input
                        type="range"
                        id="rep-diag"
                        min="0"
                        max="100"
                        value="20"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Repetition Length
                    <span class="value-display" id="replength-val">3</span>
                    <input
                        type="range"
                        id="replength"
                        min="2"
                        max="8"
                        value="3"
                        oninput="updateConfig()"
                    />
                </label>
            </div>

            <div class="control-group">
                <h2>Spatial Effects</h2>
                <label>
                    Position Drift
                    <span class="value-display" id="drift-val">50%</span>
                    <input
                        type="range"
                        id="drift"
                        min="0"
                        max="100"
                        value="50"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Cluster Strength
                    <span class="value-display" id="cluster-val">40%</span>
                    <input
                        type="range"
                        id="cluster"
                        min="0"
                        max="100"
                        value="40"
                        oninput="updateConfig()"
                    />
                </label>
                <label>
                    Edge Bias (Center ‚Üî Edge)
                    <span class="value-display" id="edgebias-val">50%</span>
                    <input
                        type="range"
                        id="edgebias"
                        min="0"
                        max="100"
                        value="50"
                        oninput="updateConfig()"
                    />
                </label>
            </div>

            <div class="control-group">
                <h2>Macro Shape</h2>
                <div class="checkbox-group">
                    <label
                        ><input
                            type="checkbox"
                            id="macro-shape-enable"
                            onchange="updateConfig()"
                        />
                        Enable Macro Shape</label
                    >
                </div>
                <div
                    id="macro-shape-controls"
                    style="
                        margin-top: 10px;
                        padding-left: 10px;
                        border-left: 2px solid #ddd;
                    "
                >
                    <label>
                        Shape Character:
                        <input
                            type="text"
                            id="macro-shape-char"
                            value="A"
                            maxlength="20"
                            oninput="updateConfig()"
                            style="
                                width: 100px;
                                font-family: &quot;Special Elite&quot;;
                                text-transform: uppercase;
                            "
                        />
                    </label>
                    <label>
                        Mode:
                        <select id="macro-shape-mode" onchange="updateConfig()">
                            <option value="normal">Normal (Dark Shape)</option>
                            <option value="inverse">
                                Inverse (Light Shape)
                            </option>
                        </select>
                    </label>
                    <label>
                        Mask Strength
                        <span class="value-display" id="macro-strength-val"
                            >100%</span
                        >
                        <input
                            type="range"
                            id="macro-shape-strength"
                            min="0"
                            max="100"
                            value="100"
                            oninput="updateConfig()"
                        />
                    </label>
                    <label>
                        Shape Size
                        <span class="value-display" id="macro-size-val"
                            >80%</span
                        >
                        <input
                            type="range"
                            id="macro-shape-size"
                            min="20"
                            max="100"
                            value="80"
                            oninput="updateConfig()"
                        />
                    </label>
                    <label>
                        Pos X
                        <span class="value-display" id="macro-x-val">0%</span>
                        <input
                            type="range"
                            id="macro-shape-x"
                            min="0"
                            max="100"
                            value="0"
                            oninput="updateConfig()"
                        />
                    </label>
                    <label>
                        Pos Y
                        <span class="value-display" id="macro-y-val">0%</span>
                        <input
                            type="range"
                            id="macro-shape-y"
                            min="0"
                            max="100"
                            value="0"
                            oninput="updateConfig()"
                        />
                    </label>
                </div>
            </div>

            <div class="control-group">
                <h2>Character Sets</h2>
                <div class="checkbox-group">
                    <label
                        ><input
                            type="checkbox"
                            id="set-latin"
                            checked
                            onchange="updateConfig()"
                        />
                        Latin Letters</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-numbers"
                            checked
                            onchange="updateConfig()"
                        />
                        Numbers</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-symbols"
                            checked
                            onchange="updateConfig()"
                        />
                        Symbols</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-cyrillic"
                            onchange="updateConfig()"
                        />
                        Cyrillic</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-special"
                            onchange="updateConfig()"
                        />
                        Special Unicode</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-corruption"
                            checked
                            onchange="updateConfig()"
                        />
                        Box Characters</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-walls"
                            checked
                            onchange="updateConfig()"
                        />
                        Walls (Lines)</label
                    >
                    <label
                        ><input
                            type="checkbox"
                            id="set-custom"
                            onchange="updateConfig()"
                        />
                        Custom:</label
                    >
                    <input
                        type="text"
                        id="custom-chars"
                        placeholder="Enter custom chars"
                        oninput="updateConfig()"
                        style="
                            width: 100%;
                            margin-top: 5px;
                            background: #333;
                            border: 1px solid #555;
                            color: white;
                            padding: 4px;
                        "
                    />
                </div>
            </div>

            <div class="control-group">
                <h2>Horizontal Lines</h2>
                <div class="checkbox-with-regen">
                    <label
                        ><input
                            type="checkbox"
                            id="effect-horiz-lines"
                            onchange="updateConfig()"
                        />
                        Enable Horizontal Lines</label
                    >
                    <button class="mini" onclick="regenerateHorizLines()">
                        ‚ü≥
                    </button>
                </div>

                <div
                    id="horiz-lines-controls"
                    style="
                        margin-top: 10px;
                        padding-left: 10px;
                        border-left: 2px solid #ddd;
                    "
                >
                    <label>
                        Density
                        <span class="value-display" id="horiz-density-val"
                            >50%</span
                        >
                        <input
                            type="range"
                            id="horiz-density"
                            min="1"
                            max="100"
                            value="50"
                            oninput="updateConfig()"
                        />
                    </label>
                    <label>
                        Max Length
                        <span class="value-display" id="horiz-length-val"
                            >50%</span
                        >
                        <input
                            type="range"
                            id="horiz-length"
                            min="10"
                            max="100"
                            value="50"
                            oninput="updateConfig()"
                        />
                    </label>
                    <label>
                        Character Set:
                        <select
                            id="horiz-charset"
                            onchange="updateConfig()"
                            style="width: 100%; margin-top: 5px"
                        >
                            <option value="walls">Walls (Lines)</option>
                            <option value="corruption">
                                Corruption Blocks
                            </option>
                            <option value="latin">Latin Text</option>
                            <option value="mixed">Mixed Random</option>
                        </select>
                    </label>
                </div>
            </div>

            <div class="control-group">
                <h2>Visual Artifacts</h2>
                <div class="checkbox-group">
                    <div class="checkbox-with-regen">
                        <label
                            ><input
                                type="checkbox"
                                id="effect-stains"
                                onchange="updateConfig()"
                            />
                            Photocopier Stains</label
                        >
                        <button class="mini" onclick="regenerateStains()">
                            ‚ü≥
                        </button>
                    </div>
                    <div class="checkbox-with-regen">
                        <label
                            ><input
                                type="checkbox"
                                id="effect-noise"
                                checked
                                onchange="updateConfig()"
                            />
                            Background Noise</label
                        >
                        <button class="mini" onclick="regenerateNoise()">
                            ‚ü≥
                        </button>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h2>Glitch Effects</h2>
                <div class="checkbox-group">
                    <div class="checkbox-with-regen">
                        <label
                            ><input
                                type="checkbox"
                                id="effect-scanlines"
                                checked
                                onchange="updateConfig()"
                            />
                            Scan Lines</label
                        >
                        <button class="mini" onclick="regenerateScanlines()">
                            ‚ü≥
                        </button>
                    </div>
                    <div class="checkbox-with-regen">
                        <label
                            ><input
                                type="checkbox"
                                id="effect-ghosting"
                                checked
                                onchange="updateConfig()"
                            />
                            Character Ghosting</label
                        >
                        <button class="mini" onclick="regenerateCharacters()">
                            ‚ü≥
                        </button>
                    </div>
                    <div class="checkbox-with-regen">
                        <label
                            ><input
                                type="checkbox"
                                id="effect-blocks"
                                checked
                                onchange="updateConfig()"
                            />
                            Compression Blocks</label
                        >
                        <button class="mini" onclick="regenerateBlocks()">
                            ‚ü≥
                        </button>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h2>Source Document (Optional)</h2>
                <div class="checkbox-group">
                    <label
                        ><input
                            type="checkbox"
                            id="use-source"
                            onchange="updateConfig()"
                        />
                        Use Source Text</label
                    >
                </div>
                <textarea
                    id="source-text"
                    placeholder="Paste text here to glitch an actual document..."
                ></textarea>
            </div>

            <div class="control-group">
                <button onclick="regenerateAll()">‚ü≥ Regenerate All</button>
                <button onclick="regenerateCharacters()" class="secondary">
                    ‚ü≥ Regen Characters
                </button>
                <button onclick="saveImage()" class="secondary">
                    üíæ Save Image
                </button>
                <button onclick="randomize()" class="secondary">
                    üé≤ Randomize All
                </button>
            </div>
        </div>
        <script>
            // Configuration object
            let config = {
                density: 0.3,
                corruptionLevel: 0.7,
                repetitionHoriz: 0.2,
                repetitionVert: 0.2,
                repetitionDiag: 0.2,
                repetitionLength: 3,
                sizeVariation: 0.5,
                clusterStrength: 0.4,
                positionDrift: 0.5,
                edgeBias: 0.5,
                baseFontSize: 12,
                useSourceDoc: false,
                sourceText: "",

                // New Settings
                horizLinesDensity: 0.5,
                horizLinesLength: 0.5,
                horizLinesCharSet: "walls",

                // Macro Shape Settings
                macroShapeEnabled: false,
                macroShapeChar: "A",
                macroShapeMode: "normal",
                macroShapeSize: 0.8,
                macroShapeStrength: 1.0,
                macroShapeX: 0.0,
                macroShapeY: 0.0,

                charSets: {
                    latin: true,
                    numbers: true,
                    symbols: true,
                    cyrillic: false,
                    special: false,
                    corruption: true,
                    walls: true,
                    custom: false,
                    customChars: "",
                },
                effects: {
                    scanlines: true,
                    ghosting: true,
                    blocks: true,
                    horizLines: false,
                    stains: false,
                    noise: true,
                },
            };

            // Character set definitions
            const charSets = {
                latin: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",
                numbers: "0123456789",
                symbols: "!@#$%^&*(){}[]|\\/<>~`-_=+;:'\",.",
                cyrillic:
                    "–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–™–´–¨–≠–Æ–Ø–∞–±–≤–≥–¥–µ—ë–∂–∑–∏–π–∫–ª–º–Ω–æ–ø—Ä—Å—Ç—É—Ñ—Ö—Ü—á—à—â—ä—ã—å—ç—é—è",
                special: "‚Üí‚Üê‚Üë‚Üì‚àû‚âà‚â†¬±√ó√∑¬ß¬∂‚Ä†‚Ä°¬©¬Æ‚Ñ¢‚Ç¨¬£¬•¬¢¬∞‚Ä¢¬∑‚Ä¶\"\"''‚Äî‚Äì",
                corruption: "‚ñì‚ñí‚ñë‚ñà‚ñÑ‚ñÄ‚ñ†‚ñ°‚óè‚óã‚óÜ‚óá‚ñ™‚ñ´",
                walls: "‚ïë‚îÇ‚îÉ‚îÇ‚ñê‚ñç‚ñé‚ñè‚ñå‚îÇ‚ïë‚îÇ‚îÉ‚îÇ‚îå‚îê‚îî‚îò‚ïî‚ïó‚ïö‚ïù‚ï†‚ï£‚ï¶‚ï©‚ï¨‚îº‚ïê‚îÄ",
            };

            function randomChar(str) {
                if (!str || str.length === 0) return " ";
                return str.charAt(floor(random(str.length)));
            }

            // Layer storage - each layer is independent
            let layers = {
                noise: null,
                stains: null,
                characters: null,
                ghosting: null,
                horizLines: null,
                scanlines: null,
                blocks: null,
            };

            let glitchPositions = [];
            let canvasWidth = 800;
            let canvasHeight = 1000;
            let macroShapeMask = null; // Stores the macro shape mask

            function setup() {
                let canvas = createCanvas(canvasWidth, canvasHeight);
                canvas.parent("canvas-container");
                textFont("Special Elite");

                regenerateAll();
            }

            function draw() {
                // Static image - only composite when needed
            }

            // Composite all layers
            function compositeImage() {
                background(255);

                // Layer 1: Background Noise
                if (config.effects.noise && layers.noise) {
                    image(layers.noise, 0, 0);
                }

                // Layer 2: Stains
                if (config.effects.stains && layers.stains) {
                    image(layers.stains, 0, 0);
                }

                // Layer 3: Ghosting
                if (config.effects.ghosting && layers.ghosting) {
                    image(layers.ghosting, 0, 0);
                }

                // Layer 4: Main Characters
                if (layers.characters) {
                    image(layers.characters, 0, 0);
                }

                // Layer 5: Horizontal Lines
                if (config.effects.horizLines && layers.horizLines) {
                    image(layers.horizLines, 0, 0);
                }

                // Layer 6: Scanlines
                if (config.effects.scanlines && layers.scanlines) {
                    image(layers.scanlines, 0, 0);
                }

                // Layer 7: Compression Blocks
                if (config.effects.blocks && layers.blocks) {
                    image(layers.blocks, 0, 0);
                }
            }

            window.updateCanvasSize = function () {
                let mode = document.getElementById("canvas-size").value;

                if (mode === "screen") {
                    canvasWidth = 800;
                    canvasHeight = 1000;
                } else if (mode === "a4") {
                    canvasWidth = 595;
                    canvasHeight = 842;
                } else if (mode === "a3") {
                    canvasWidth = 842;
                    canvasHeight = 1191;
                } else if (mode === "a2") {
                    canvasWidth = 1191;
                    canvasHeight = 1684;
                } else if (mode === "a1") {
                    canvasWidth = 1684;
                    canvasHeight = 2384;
                } else if (mode === "4k") {
                    canvasWidth = 3840;
                    canvasHeight = 2160;
                }

                resizeCanvas(canvasWidth, canvasHeight);
                regenerateAll();
            };

            // Regenerate everything
            function regenerateAll() {
                regenerateNoise();
                regenerateStains();
                regenerateCharacters();
                regenerateHorizLines();
                regenerateScanlines();
                regenerateBlocks();
            }

            // Individual regeneration functions
            function regenerateNoise() {
                if (layers.noise) layers.noise.remove();
                layers.noise = createGraphics(canvasWidth, canvasHeight);

                layers.noise.loadPixels();
                for (let i = 0; i < layers.noise.pixels.length; i += 4) {
                    if (random() < 0.03) {
                        let shade = random(150, 230);
                        layers.noise.pixels[i] = shade;
                        layers.noise.pixels[i + 1] = shade;
                        layers.noise.pixels[i + 2] = shade;
                        layers.noise.pixels[i + 3] = 255;
                    } else {
                        layers.noise.pixels[i + 3] = 0; // Transparent
                    }
                }
                layers.noise.updatePixels();
                compositeImage();
            }

            function regenerateStains() {
                if (layers.stains) layers.stains.remove();
                layers.stains = createGraphics(canvasWidth, canvasHeight);
                layers.stains.clear();

                drawStainsToLayer(layers.stains);
                compositeImage();
            }

            function regenerateCharacters() {
                // Regenerate macro shape mask if enabled
                generateMacroShapeMask();

                // Regenerate character positions
                glitchPositions = config.useSourceDoc
                    ? generateFromSource()
                    : generateRandomPositions();

                // Regenerate character layer
                if (layers.characters) layers.characters.remove();
                layers.characters = createGraphics(canvasWidth, canvasHeight);
                layers.characters.clear();
                drawCharactersToLayer(layers.characters);

                // Also regenerate ghosting since it depends on character positions
                if (layers.ghosting) layers.ghosting.remove();
                layers.ghosting = createGraphics(canvasWidth, canvasHeight);
                layers.ghosting.clear();
                drawGhostingToLayer(layers.ghosting);

                compositeImage();
            }

            function regenerateHorizLines() {
                if (layers.horizLines) layers.horizLines.remove();
                layers.horizLines = createGraphics(canvasWidth, canvasHeight);
                layers.horizLines.clear();

                drawHorizontalLinesToLayer(layers.horizLines);
                compositeImage();
            }

            function regenerateScanlines() {
                if (layers.scanlines) layers.scanlines.remove();
                layers.scanlines = createGraphics(canvasWidth, canvasHeight);
                layers.scanlines.clear();

                drawScanlinesToLayer(layers.scanlines);
                compositeImage();
            }

            function regenerateBlocks() {
                if (layers.blocks) layers.blocks.remove();
                layers.blocks = createGraphics(canvasWidth, canvasHeight);
                layers.blocks.clear();

                drawCompressionBlocksToLayer(layers.blocks);
                compositeImage();
            }

            // Generate macro shape mask
            function generateMacroShapeMask() {
                if (!config.macroShapeEnabled || !config.macroShapeChar) {
                    if (macroShapeMask) {
                        macroShapeMask.remove();
                        macroShapeMask = null;
                    }
                    return;
                }

                if (macroShapeMask) macroShapeMask.remove();
                macroShapeMask = createGraphics(canvasWidth, canvasHeight);

                macroShapeMask.background(255);
                macroShapeMask.fill(0);
                macroShapeMask.noStroke();

                macroShapeMask.textFont("Special Elite");

                // Calculate font size.
                // If text is long, user may need to reduce size manually.
                let targetSize =
                    min(canvasWidth, canvasHeight) * config.macroShapeSize;
                macroShapeMask.textSize(targetSize);

                let x = canvasWidth * (config.macroShapeX || 0);
                let y = canvasHeight * (config.macroShapeY || 0);
                let w = canvasWidth - x; // Fill remaining width
                let h = canvasHeight - y; // Fill remaining height

                // If user selects 0,0 (default), box is full canvas.
                // We use CENTER, CENTER to center the text in that box.
                macroShapeMask.textAlign(CENTER, CENTER);

                // Draw the macro shape character(s) with word wrapping
                macroShapeMask.text(config.macroShapeChar, x, y, w, h);

                // Load pixels for sampling
                macroShapeMask.loadPixels();
            }

            function sampleMacroShape(x, y) {
                if (!macroShapeMask || !config.macroShapeEnabled) return 0.5;

                // Handle pixel density for high DPI displays
                let d = macroShapeMask.pixelDensity();

                let physX = floor(x * d);
                let physY = floor(y * d);
                let physW = macroShapeMask.width * d;
                let physH = macroShapeMask.height * d;

                let ix = constrain(physX, 0, physW - 1);
                let iy = constrain(physY, 0, physH - 1);

                let index = (ix + iy * physW) * 4;

                // Safety check
                if (
                    !macroShapeMask.pixels ||
                    index >= macroShapeMask.pixels.length
                )
                    return 0.5;

                // Get brightness (0 = black/shape, 255 = white/background)
                let brightness = macroShapeMask.pixels[index] / 255.0;

                // Return mask value based on mode
                if (config.macroShapeMode === "normal") {
                    // Normal: higher value where shape is (dark pixels)
                    return 1.0 - brightness;
                } else {
                    // Inverse: higher value where background is (light pixels)
                    return brightness;
                }
            }

            function generateRandomPositions() {
                let positions = [];
                let charPool = getActiveCharPool();
                if (charPool.length === 0) charPool = ["X"];

                noiseSeed(random(10000));
                let gridSpacing = config.baseFontSize * 1.2;

                for (let y = 0; y < canvasHeight; y += gridSpacing) {
                    for (let x = 0; x < canvasWidth; x += gridSpacing) {
                        let noiseVal = noise(x * 0.005, y * 0.005);

                        let normalizedX = x / canvasWidth;
                        let distFromCenter = abs(normalizedX - 0.5) * 2;
                        let biasFactor = 1;
                        if (config.edgeBias > 0.5) {
                            let strength = map(config.edgeBias, 0.5, 1, 0, 1);
                            biasFactor = map(
                                distFromCenter,
                                0,
                                1,
                                1 - strength,
                                1 + strength,
                            );
                        } else {
                            let strength = map(config.edgeBias, 0.5, 0, 0, 1);
                            biasFactor = map(
                                distFromCenter,
                                0,
                                1,
                                1 + strength,
                                1 - strength,
                            );
                        }
                        noiseVal *= biasFactor;

                        // Apply macro shape mask if enabled
                        if (config.macroShapeEnabled && macroShapeMask) {
                            let shapeMask = sampleMacroShape(x, y);
                            // Blend noise with shape mask based on strength
                            let strength = config.macroShapeStrength;
                            noiseVal =
                                noiseVal * (1 - strength) +
                                shapeMask * strength;
                        }

                        let densityThreshold = 1 - config.density;
                        let clusterMod = map(
                            config.clusterStrength,
                            0,
                            1,
                            0.5,
                            1.5,
                        );
                        noiseVal = pow(noiseVal, clusterMod);

                        if (noiseVal > densityThreshold) {
                            let driftX = randomGaussian(
                                0,
                                config.positionDrift * 15,
                            );
                            let driftY = randomGaussian(
                                0,
                                config.positionDrift * 8,
                            );
                            let char = randomChar(charPool.join(""));

                            positions.push({
                                x: x + driftX,
                                y: y + driftY,
                                char: char,
                                size:
                                    config.baseFontSize *
                                    random(
                                        1 - config.sizeVariation,
                                        1 + config.sizeVariation,
                                    ),
                                opacity: random(180, 255),
                            });

                            if (random() < config.repetitionHoriz) {
                                let repeatCount = floor(
                                    random(2, config.repetitionLength + 1),
                                );
                                for (let r = 1; r <= repeatCount; r++) {
                                    positions.push({
                                        x: x + driftX + r * gridSpacing * 0.8,
                                        y: y + driftY,
                                        char: char,
                                        size:
                                            config.baseFontSize *
                                            random(
                                                1 - config.sizeVariation * 0.5,
                                                1 + config.sizeVariation * 0.5,
                                            ),
                                        opacity: random(150, 255),
                                    });
                                }
                            }
                            if (random() < config.repetitionVert) {
                                let repeatCount = floor(
                                    random(2, config.repetitionLength + 1),
                                );
                                for (let r = 1; r <= repeatCount; r++) {
                                    positions.push({
                                        x: x + driftX,
                                        y: y + driftY + r * gridSpacing * 0.8,
                                        char: char,
                                        size:
                                            config.baseFontSize *
                                            random(
                                                1 - config.sizeVariation * 0.5,
                                                1 + config.sizeVariation * 0.5,
                                            ),
                                        opacity: random(150, 255),
                                    });
                                }
                            }
                            if (random() < config.repetitionDiag) {
                                let repeatCount = floor(
                                    random(2, config.repetitionLength + 1),
                                );
                                let diagDir = random() < 0.5 ? 1 : -1;
                                for (let r = 1; r <= repeatCount; r++) {
                                    positions.push({
                                        x:
                                            x +
                                            driftX +
                                            diagDir * r * gridSpacing * 0.6,
                                        y: y + driftY + r * gridSpacing * 0.6,
                                        char: char,
                                        size:
                                            config.baseFontSize *
                                            random(
                                                1 - config.sizeVariation * 0.5,
                                                1 + config.sizeVariation * 0.5,
                                            ),
                                        opacity: random(150, 255),
                                    });
                                }
                            }
                        }
                    }
                }
                return positions;
            }

            function generateFromSource() {
                let positions = [];
                let charPool = getActiveCharPool();
                let text = config.sourceText || "NO SOURCE TEXT PROVIDED";
                let chars = text.split("");

                let x = 50;
                let y = 50;
                let lineHeight = config.baseFontSize * 1.8;
                let charWidth = config.baseFontSize * 0.7;

                for (let i = 0; i < chars.length; i++) {
                    let char = chars[i];
                    if (char === "\n") {
                        x = 50;
                        y += lineHeight;
                        continue;
                    }

                    if (random() < config.corruptionLevel)
                        char = random(charPool);

                    let driftX = randomGaussian(0, config.corruptionLevel * 20);
                    let driftY = randomGaussian(0, config.corruptionLevel * 10);

                    positions.push({
                        x: x + driftX,
                        y: y + driftY,
                        char: char,
                        size:
                            config.baseFontSize *
                            random(
                                1 - config.sizeVariation * 0.5,
                                1 + config.sizeVariation * 0.5,
                            ),
                        opacity: random(150, 255),
                    });

                    x += charWidth;
                    if (x > canvasWidth - 100) {
                        x = 50;
                        y += lineHeight;
                    }
                    if (y > canvasHeight - 50) break;
                }
                return positions;
            }

            function drawCharactersToLayer(layer) {
                layer.fill(0);
                layer.noStroke();
                layer.textFont("Special Elite");
                for (let p of glitchPositions) {
                    layer.push();
                    layer.translate(p.x, p.y);
                    layer.textSize(p.size);
                    layer.fill(0, p.opacity);
                    layer.textAlign(CENTER, CENTER);
                    layer.text(p.char, 0, 0);
                    layer.pop();
                }
            }

            function drawGhostingToLayer(layer) {
                layer.fill(0, 50);
                layer.noStroke();
                layer.textFont("Special Elite");
                for (let p of glitchPositions) {
                    if (random() < 0.15) {
                        let ghostCount = floor(random(1, 4));
                        for (let i = 0; i < ghostCount; i++) {
                            layer.push();
                            layer.translate(
                                p.x + random(-5, 5),
                                p.y + random(-5, 5),
                            );
                            layer.textSize(p.size);
                            layer.textAlign(CENTER, CENTER);
                            layer.text(p.char, 0, 0);
                            layer.pop();
                        }
                    }
                }
            }

            function drawScanlinesToLayer(layer) {
                randomSeed(millis());
                layer.stroke(0, random(20, 40));
                layer.strokeWeight(random(0.5, 1.5));
                for (let y = 0; y < canvasHeight; y += random(3, 12)) {
                    let x1 = random(-20, 0);
                    let x2 = canvasWidth + random(0, 20);
                    layer.line(x1, y, x2, y);
                }
            }

            function drawCompressionBlocksToLayer(layer) {
                randomSeed(millis());
                layer.noStroke();
                for (let i = 0; i < 30; i++) {
                    layer.fill(0, random(10, 50));
                    layer.rect(
                        random(canvasWidth),
                        random(canvasHeight),
                        random(10, 80),
                        random(5, 30),
                    );
                }
                for (let i = 0; i < 15; i++) {
                    layer.fill(255, random(100, 200));
                    layer.rect(
                        random(canvasWidth),
                        random(canvasHeight),
                        random(5, 40),
                        random(3, 15),
                    );
                }
            }

            function drawStainsToLayer(layer) {
                noiseSeed(millis()); // Randomize noise field to prevent duplicate shapes
                layer.noStroke();

                let numStains = floor(random(2, 6));

                for (let i = 0; i < numStains; i++) {
                    let stainType = random(["subtle", "medium", "dark"]);

                    let placeX, placeY;
                    let posType = random();

                    if (posType < 0.3) {
                        placeX = random(0, canvasWidth * 0.25);
                        placeY = random(0, canvasHeight * 0.2);
                    } else if (posType < 0.6) {
                        placeX = random(canvasWidth * 0.2, canvasWidth * 0.8);
                        placeY = random(
                            canvasHeight * 0.35,
                            canvasHeight * 0.65,
                        );
                    } else {
                        placeX = random(canvasWidth);
                        placeY = random(canvasHeight);
                    }

                    let stainWidth = floor(random(150, 400));
                    let stainHeight = floor(random(150, 450));

                    let pg = createGraphics(stainWidth, stainHeight);

                    let baseGray, baseAlpha;
                    if (stainType === "subtle") {
                        baseGray = random(200, 230);
                        baseAlpha = random(40, 80);
                    } else if (stainType === "medium") {
                        baseGray = random(160, 200);
                        baseAlpha = random(60, 110);
                    } else {
                        baseGray = random(120, 170);
                        baseAlpha = random(80, 140);
                    }

                    pg.loadPixels();
                    // Use Math.random() to ensure independence from p5 randomSeed state
                    let noiseOffsetX = Math.random() * 100000;
                    let noiseOffsetY = Math.random() * 100000;

                    let noiseScaleCoarse = random(0.008, 0.015);
                    let noiseScaleFine = random(0.03, 0.06);

                    let dripAngle =
                        random() < 0.7 ? random(-0.3, 0.3) : random(-0.8, 0.8);

                    // Calculate random slant for top edge
                    // Range: -60 to 60 degrees
                    let angleDeg = random(-60, 60);
                    let slantTan = tan(radians(angleDeg));
                    let aspectRatio = stainWidth / stainHeight;

                    for (let y = 0; y < stainHeight; y++) {
                        for (let x = 0; x < stainWidth; x++) {
                            let index = (x + y * stainWidth) * 4;

                            let normX = x / stainWidth;
                            let normY = y / stainHeight;

                            // Reduced max width (was 0.8) to prevent clipping
                            let widthAtY = map(normY, 0, 1, 0.4, 0.1);

                            let curvature =
                                noise(y * noiseScaleCoarse + noiseOffsetY) -
                                0.5;

                            // Reduced influence of curvature and dripAngle to keep center closer to 0.5
                            let centerX =
                                0.5 +
                                curvature * 0.2 +
                                dripAngle * normY * 0.15;

                            let distFromCenterLine = abs(normX - centerX);

                            let edgeNoise = noise(
                                x * noiseScaleFine + noiseOffsetX,
                                y * noiseScaleFine + noiseOffsetY,
                            );

                            let verticalFade = map(normY, 0, 1, 1.2, 0.3);

                            // New: Organic top edge fade with Slant
                            // Calculate slant offset based on X
                            // normX goes 0 to 1. Center pivot at 0.5.
                            let slantOffset =
                                (normX - 0.5) * aspectRatio * slantTan;

                            let topEdgeNoise = noise(
                                x * 0.05 + noiseOffsetX + 1000,
                            );
                            let noiseComp = map(
                                topEdgeNoise,
                                0,
                                1,
                                -0.05,
                                0.05,
                            );

                            // Base start height (e.g., 0.15 down) plus slant plus noise
                            let topStart = 0.15 + slantOffset + noiseComp;

                            let topFade = 1.0;
                            if (normY < topStart) {
                                topFade = 0;
                            } else if (normY < topStart + 0.1) {
                                topFade = map(
                                    normY,
                                    topStart,
                                    topStart + 0.1,
                                    0,
                                    1,
                                );
                            }

                            // Apply top fade to verticalFade to keep logic clean?
                            // Or apply directly to stainMask. Let's apply to verticalFade effectively.
                            verticalFade *= topFade;

                            let edgeVariation = edgeNoise * 0.3;
                            let effectiveWidth = widthAtY + edgeVariation;

                            let stainMask =
                                (effectiveWidth - distFromCenterLine) *
                                verticalFade;

                            let tendrilNoise = noise(
                                x * 0.02 + noiseOffsetX + 500,
                                y * 0.04 + noiseOffsetY + 500,
                            );
                            if (tendrilNoise > 0.7 && normY > 0.3) {
                                stainMask += (tendrilNoise - 0.7) * 2;
                            }

                            if (stainMask > 0.2) {
                                let grayVariation =
                                    noise(x * 0.08, y * 0.08) * 30 - 15;
                                let gray = constrain(
                                    baseGray + grayVariation,
                                    0,
                                    255,
                                );

                                let alphaFalloff = map(
                                    stainMask,
                                    0.2,
                                    1.5,
                                    baseAlpha * 0.2,
                                    baseAlpha * 1.2,
                                );
                                alphaFalloff = constrain(alphaFalloff, 0, 255);

                                pg.pixels[index] = gray;
                                pg.pixels[index + 1] = gray;
                                pg.pixels[index + 2] = gray;
                                pg.pixels[index + 3] = alphaFalloff;
                            }
                        }
                    }
                    pg.updatePixels();

                    pg.filter(BLUR, random(1.8, 3.2));

                    if (random() < 0.7) {
                        pg.noStroke();

                        let numDrips = floor(random(2, 5));
                        for (let d = 0; d < numDrips; d++) {
                            let dripX = random(
                                stainWidth * 0.3,
                                stainWidth * 0.7,
                            );
                            let dripStartY = random(
                                stainHeight * 0.1,
                                stainHeight * 0.4,
                            );
                            let dripLength = random(
                                stainHeight * 0.3,
                                stainHeight * 0.7,
                            );

                            pg.stroke(
                                baseGray - random(20, 50),
                                random(20, 60),
                            );
                            pg.strokeWeight(random(0.5, 2));

                            for (let dy = 0; dy < dripLength; dy += 2) {
                                let wobble = noise(dy * 0.1) * 4 - 2;
                                let y1 = dripStartY + dy;
                                let y2 = dripStartY + dy + 2;
                                if (y2 < stainHeight) {
                                    pg.line(
                                        dripX + wobble,
                                        y1,
                                        dripX + wobble,
                                        y2,
                                    );
                                }
                            }
                        }

                        pg.noStroke();
                        let numSpots = floor(random(4, 10));
                        for (let s = 0; s < numSpots; s++) {
                            let spotX = random(
                                stainWidth * 0.25,
                                stainWidth * 0.75,
                            );
                            let spotY = random(
                                stainHeight * 0.1,
                                stainHeight * 0.6,
                            );
                            let spotSize = random(2, 12);
                            let spotGray = baseGray - random(30, 60);
                            pg.fill(spotGray, random(30, 90));
                            pg.ellipse(
                                spotX,
                                spotY,
                                spotSize,
                                spotSize * random(0.8, 1.5),
                            );
                        }

                        pg.filter(BLUR, 1.2);
                    }

                    layer.image(
                        pg,
                        placeX - stainWidth / 2,
                        placeY - stainHeight / 2,
                    );
                    pg.remove();
                }

                if (random() < 0.4) {
                    let numStreaks = floor(random(1, 3));
                    for (let s = 0; s < numStreaks; s++) {
                        let streakY = random(canvasHeight);
                        let streakWidth = random(
                            canvasWidth * 0.3,
                            canvasWidth * 0.9,
                        );
                        let streakHeight = random(8, 30);

                        let streakPg = createGraphics(
                            floor(streakWidth),
                            floor(streakHeight),
                        );
                        streakPg.loadPixels();

                        let streakNoise = random(1000);
                        for (let y = 0; y < streakHeight; y++) {
                            for (let x = 0; x < streakWidth; x++) {
                                let index = (x + y * floor(streakWidth)) * 4;
                                let n = noise(x * 0.02 + streakNoise, y * 0.1);

                                if (n > 0.4) {
                                    let gray = random(180, 220);
                                    let alpha = random(20, 50);
                                    streakPg.pixels[index] = gray;
                                    streakPg.pixels[index + 1] = gray;
                                    streakPg.pixels[index + 2] = gray;
                                    streakPg.pixels[index + 3] = alpha;
                                }
                            }
                        }
                        streakPg.updatePixels();
                        streakPg.filter(BLUR, 2);

                        layer.image(
                            streakPg,
                            random(canvasWidth * 0.1, canvasWidth * 0.3),
                            streakY,
                        );
                        streakPg.remove();
                    }
                }
            }

            function drawHorizontalLinesToLayer(layer) {
                randomSeed(millis());
                layer.fill(0);
                layer.noStroke();
                layer.textSize(config.baseFontSize);
                layer.textFont("Special Elite");

                let pool = "";
                switch (config.horizLinesCharSet) {
                    case "walls":
                        pool = charSets.walls;
                        break;
                    case "corruption":
                        pool = charSets.corruption;
                        break;
                    case "latin":
                        pool = charSets.latin;
                        break;
                    case "mixed":
                        pool = getActiveCharPool().join("");
                        break;
                    default:
                        pool = charSets.walls;
                }

                let numLines = floor(
                    map(config.horizLinesDensity, 0, 1, 1, 50),
                );

                for (let i = 0; i < numLines; i++) {
                    let y = random(10, canvasHeight - 10);
                    let char = randomChar(pool);

                    let maxChars = canvasWidth / (config.baseFontSize * 0.6);
                    let lineLengthPercent = map(
                        config.horizLinesLength,
                        0,
                        1,
                        0.05,
                        1.0,
                    );
                    let lineLen = floor(
                        random(2, maxChars * lineLengthPercent),
                    );

                    let lineStr = "";
                    for (let k = 0; k < lineLen; k++) lineStr += char;

                    layer.fill(0, random(150, 255));

                    if (lineLen > maxChars * 0.9) {
                        layer.textAlign(CENTER, CENTER);
                        layer.text(lineStr, canvasWidth / 2, y);
                    } else {
                        let startX = random(
                            0,
                            canvasWidth - lineLen * config.baseFontSize * 0.6,
                        );
                        layer.textAlign(LEFT, CENTER);
                        layer.text(lineStr, startX, y);
                    }
                }
            }

            function getActiveCharPool() {
                let pool = "";
                if (config.charSets.latin) pool += charSets.latin;
                if (config.charSets.numbers) pool += charSets.numbers;
                if (config.charSets.symbols) pool += charSets.symbols;
                if (config.charSets.cyrillic) pool += charSets.cyrillic;
                if (config.charSets.special) pool += charSets.special;
                if (config.charSets.corruption) pool += charSets.corruption;
                if (config.charSets.walls) pool += charSets.walls;
                if (config.charSets.custom && config.charSets.customChars)
                    pool += config.charSets.customChars;
                return pool.split("");
            }

            window.updateConfig = function () {
                // Track if we need to regenerate specific layers
                let needCharacterRegen = false;
                let needHorizLinesRegen = false;

                // Character settings - check if they changed
                let oldDensity = config.density;
                let oldCorruption = config.corruptionLevel;
                let oldFontSize = config.baseFontSize;
                let oldSizeVar = config.sizeVariation;
                let oldRepHoriz = config.repetitionHoriz;
                let oldRepVert = config.repetitionVert;
                let oldRepDiag = config.repetitionDiag;
                let oldRepLength = config.repetitionLength;
                let oldDrift = config.positionDrift;
                let oldCluster = config.clusterStrength;
                let oldEdgeBias = config.edgeBias;
                let oldCharSets = { ...config.charSets };
                let oldUseSource = config.useSourceDoc;
                let oldSourceText = config.sourceText;

                // Horizontal lines settings
                let oldHorizDensity = config.horizLinesDensity;
                let oldHorizLength = config.horizLinesLength;
                let oldHorizCharSet = config.horizLinesCharSet;

                // Macro shape settings
                let oldMacroEnabled = config.macroShapeEnabled;
                let oldMacroChar = config.macroShapeChar;
                let oldMacroMode = config.macroShapeMode;
                let oldMacroSize = config.macroShapeSize;
                let oldMacroStrength = config.macroShapeStrength;
                let oldMacroX = config.macroShapeX;
                let oldMacroY = config.macroShapeY;

                // Update config
                config.density = document.getElementById("density").value / 100;
                config.corruptionLevel =
                    document.getElementById("corruption").value / 100;
                config.baseFontSize = parseInt(
                    document.getElementById("fontsize").value,
                );
                config.sizeVariation =
                    document.getElementById("sizevar").value / 100;

                config.repetitionHoriz =
                    document.getElementById("rep-horiz").value / 100;
                config.repetitionVert =
                    document.getElementById("rep-vert").value / 100;
                config.repetitionDiag =
                    document.getElementById("rep-diag").value / 100;
                config.repetitionLength = parseInt(
                    document.getElementById("replength").value,
                );

                config.positionDrift =
                    document.getElementById("drift").value / 100;
                config.clusterStrength =
                    document.getElementById("cluster").value / 100;
                config.edgeBias =
                    document.getElementById("edgebias").value / 100;

                config.horizLinesDensity =
                    document.getElementById("horiz-density").value / 100;
                config.horizLinesLength =
                    document.getElementById("horiz-length").value / 100;
                config.horizLinesCharSet =
                    document.getElementById("horiz-charset").value;

                // Macro shape config
                config.macroShapeEnabled =
                    document.getElementById("macro-shape-enable").checked;
                config.macroShapeChar =
                    document.getElementById("macro-shape-char").value;
                config.macroShapeMode =
                    document.getElementById("macro-shape-mode").value;
                config.macroShapeSize =
                    document.getElementById("macro-shape-size").value / 100;
                config.macroShapeStrength =
                    document.getElementById("macro-shape-strength").value / 100;
                config.macroShapeX =
                    document.getElementById("macro-shape-x").value / 100;
                config.macroShapeY =
                    document.getElementById("macro-shape-y").value / 100;

                config.effects.horizLines =
                    document.getElementById("effect-horiz-lines").checked;
                config.effects.stains =
                    document.getElementById("effect-stains").checked;
                config.effects.noise =
                    document.getElementById("effect-noise").checked;
                config.effects.scanlines =
                    document.getElementById("effect-scanlines").checked;
                config.effects.ghosting =
                    document.getElementById("effect-ghosting").checked;
                config.effects.blocks =
                    document.getElementById("effect-blocks").checked;

                document.getElementById("density-val").textContent =
                    document.getElementById("density").value + "%";
                document.getElementById("corruption-val").textContent =
                    document.getElementById("corruption").value + "%";
                document.getElementById("fontsize-val").textContent =
                    document.getElementById("fontsize").value;
                document.getElementById("sizevar-val").textContent =
                    document.getElementById("sizevar").value + "%";
                document.getElementById("rep-horiz-val").textContent =
                    document.getElementById("rep-horiz").value + "%";
                document.getElementById("rep-vert-val").textContent =
                    document.getElementById("rep-vert").value + "%";
                document.getElementById("rep-diag-val").textContent =
                    document.getElementById("rep-diag").value + "%";
                document.getElementById("replength-val").textContent =
                    document.getElementById("replength").value;
                document.getElementById("drift-val").textContent =
                    document.getElementById("drift").value + "%";
                document.getElementById("cluster-val").textContent =
                    document.getElementById("cluster").value + "%";
                document.getElementById("edgebias-val").textContent =
                    document.getElementById("edgebias").value + "%";

                document.getElementById("horiz-density-val").textContent =
                    document.getElementById("horiz-density").value + "%";
                document.getElementById("horiz-length-val").textContent =
                    document.getElementById("horiz-length").value + "%";

                document.getElementById("macro-size-val").textContent =
                    document.getElementById("macro-shape-size").value + "%";
                document.getElementById("macro-strength-val").textContent =
                    document.getElementById("macro-shape-strength").value + "%";
                document.getElementById("macro-x-val").textContent =
                    document.getElementById("macro-shape-x").value + "%";
                document.getElementById("macro-y-val").textContent =
                    document.getElementById("macro-shape-y").value + "%";

                config.charSets.latin =
                    document.getElementById("set-latin").checked;
                config.charSets.numbers =
                    document.getElementById("set-numbers").checked;
                config.charSets.symbols =
                    document.getElementById("set-symbols").checked;
                config.charSets.cyrillic =
                    document.getElementById("set-cyrillic").checked;
                config.charSets.special =
                    document.getElementById("set-special").checked;
                config.charSets.corruption =
                    document.getElementById("set-corruption").checked;
                config.charSets.walls =
                    document.getElementById("set-walls").checked;
                config.charSets.custom =
                    document.getElementById("set-custom").checked;
                config.charSets.customChars =
                    document.getElementById("custom-chars").value;

                config.useSourceDoc =
                    document.getElementById("use-source").checked;
                config.sourceText =
                    document.getElementById("source-text").value;

                // Check if character-related settings changed
                if (
                    oldDensity !== config.density ||
                    oldCorruption !== config.corruptionLevel ||
                    oldFontSize !== config.baseFontSize ||
                    oldSizeVar !== config.sizeVariation ||
                    oldRepHoriz !== config.repetitionHoriz ||
                    oldRepVert !== config.repetitionVert ||
                    oldRepDiag !== config.repetitionDiag ||
                    oldRepLength !== config.repetitionLength ||
                    oldDrift !== config.positionDrift ||
                    oldCluster !== config.clusterStrength ||
                    oldEdgeBias !== config.edgeBias ||
                    oldUseSource !== config.useSourceDoc ||
                    oldSourceText !== config.sourceText ||
                    oldCharSets.latin !== config.charSets.latin ||
                    oldCharSets.numbers !== config.charSets.numbers ||
                    oldCharSets.symbols !== config.charSets.symbols ||
                    oldCharSets.cyrillic !== config.charSets.cyrillic ||
                    oldCharSets.special !== config.charSets.special ||
                    oldCharSets.corruption !== config.charSets.corruption ||
                    oldCharSets.walls !== config.charSets.walls ||
                    oldCharSets.custom !== config.charSets.custom ||
                    oldCharSets.customChars !== config.charSets.customChars ||
                    oldMacroEnabled !== config.macroShapeEnabled ||
                    oldMacroChar !== config.macroShapeChar ||
                    oldMacroMode !== config.macroShapeMode ||
                    oldMacroSize !== config.macroShapeSize ||
                    oldMacroStrength !== config.macroShapeStrength ||
                    oldMacroX !== config.macroShapeX ||
                    oldMacroY !== config.macroShapeY
                ) {
                    needCharacterRegen = true;
                }

                // Check if horizontal lines settings changed
                if (
                    oldHorizDensity !== config.horizLinesDensity ||
                    oldHorizLength !== config.horizLinesLength ||
                    oldHorizCharSet !== config.horizLinesCharSet
                ) {
                    needHorizLinesRegen = true;
                }

                // Regenerate affected layers
                if (needCharacterRegen) {
                    regenerateCharacters();
                } else if (needHorizLinesRegen) {
                    regenerateHorizLines();
                } else {
                    // Just recomposite if only effect toggles changed
                    compositeImage();
                }
            };

            function saveImage() {
                saveCanvas("glitch-art-" + Date.now(), "png");
            }

            function randomize() {
                let ids = [
                    "density",
                    "corruption",
                    "rep-horiz",
                    "rep-vert",
                    "rep-diag",
                    "sizevar",
                    "cluster",
                    "drift",
                    "edgebias",
                    "horiz-density",
                    "horiz-length",
                    "macro-shape-x",
                    "macro-shape-y",
                    "macro-shape-size",
                    "macro-shape-strength",
                ];
                for (let id of ids)
                    document.getElementById(id).value = floor(random(10, 90));

                document.getElementById("fontsize").value = floor(
                    random(8, 16),
                );
                document.getElementById("replength").value = floor(
                    random(2, 6),
                );

                document.getElementById("set-walls").checked = random() > 0.5;
                document.getElementById("set-corruption").checked =
                    random() > 0.5;
                document.getElementById("set-latin").checked = random() > 0.5;
                document.getElementById("set-numbers").checked = random() > 0.5;
                document.getElementById("set-symbols").checked = random() > 0.5;

                document.getElementById("effect-scanlines").checked =
                    random() > 0.5;
                document.getElementById("effect-ghosting").checked =
                    random() > 0.5;
                document.getElementById("effect-blocks").checked =
                    random() > 0.5;
                document.getElementById("effect-stains").checked =
                    random() > 0.5;
                document.getElementById("effect-horiz-lines").checked =
                    random() > 0.5;
                document.getElementById("effect-noise").checked =
                    random() > 0.5;

                const charSetOptions = [
                    "walls",
                    "corruption",
                    "latin",
                    "mixed",
                ];
                document.getElementById("horiz-charset").value =
                    random(charSetOptions);

                updateConfig();
            }
        </script>
    </body>
</html>
